{% extends "base.html" %}

{% block title %}原礦精煉 - 掛機挖礦服務{% endblock %}

{% block content %}
<div class="row">
    <!-- 元素庫存 -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-atom text-primary me-2"></i>元素庫存
                </h5>
                <div class="row" id="element-inventory">
                    <!-- 元素庫存將通過JavaScript動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 精煉功能 -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-industry text-primary me-2"></i>原礦精煉
                </h5>
                
                <form method="POST" action="{{ url_for('refine') }}">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="refinery_id" class="form-label">選擇精煉廠</label>
                            <select class="form-select" id="refinery_id" name="refinery_id" required>
                                <option value="">請選擇精煉廠</option>
                                {% for refinery in refineries %}
                                <option value="{{ refinery.id }}" 
                                        data-efficiency="{{ refinery.efficiency }}"
                                        data-cost="{{ refinery.cost_per_ore }}"
                                        data-refining-multiplier="{{ refinery.refining_multiplier }}"
                                        data-environment-multiplier="{{ refinery.environment_multiplier }}"
                                        data-correction-factor="{{ refinery.correction_factor }}">
                                    {{ refinery.name }} (效率: {{ refinery.efficiency }}x)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="ore_amount" class="form-label">原礦數量</label>
                            <input type="number" class="form-control" id="ore_amount" name="ore_amount" 
                                   min="1" max="{{ current_user.balance|int }}" value="100" required>
                            <div class="form-text">可用原礦: {{ current_user.balance|int }}</div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">產出材料</label>
                            <div class="form-control-plaintext text-muted">
                                <i class="fas fa-random me-2"></i>由系統隨機決定
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div id="refining-preview" class="alert alert-info" style="display: none;">
                                <h6>精煉預覽</h6>
                                <p id="preview-text"></p>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-cog me-2"></i>開始精煉
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 精煉廠信息 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>精煉廠信息
                </h5>
                <div class="row">
                    {% for refinery in refineries %}
                    <div class="col-md-4 mb-3">
                        <div class="refinery-info">
                            <h6>{{ refinery.name }}</h6>
                            <p class="text-muted">{{ refinery.description }}</p>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">效率</small><br>
                                    <span class="badge bg-primary">{{ refinery.efficiency }}x</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">成本/原礦</small><br>
                                    <span class="badge bg-warning">{{ refinery.cost_per_ore }}</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-4">
                                    <small class="text-muted">精煉倍數</small><br>
                                    <span class="badge bg-success">{{ refinery.refining_multiplier }}x</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">環境倍數</small><br>
                                    <span class="badge bg-info">{{ refinery.environment_multiplier }}x</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">修正系數</small><br>
                                    <span class="badge bg-secondary">{{ refinery.correction_factor }}x</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">容量使用</small>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ (refinery.current_usage / refinery.max_capacity * 100)|round(1) if refinery.max_capacity < 999999999 else 0 }}%">
                                        {% if refinery.max_capacity >= 999999999 %}
                                            無上限
                                        {% else %}
                                            {{ refinery.current_usage }}/{{ refinery.max_capacity }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 精煉記錄 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-history text-primary me-2"></i>精煉記錄
                </h5>
                
                {% if recent_refining %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>時間</th>
                                <th>精煉廠</th>
                                <th>材料</th>
                                <th>消耗原礦</th>
                                <th>獲得材料</th>
                                <th>成本</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in recent_refining %}
                            <tr>
                                <td>{{ record.refining_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ record.refinery.name }}</td>
                                <td>
                                    <span class="badge bg-info">{{ record.material.name }}</span>
                                </td>
                                <td>{{ record.ore_amount|int }}</td>
                                <td>{{ record.material_amount|round(2) }}</td>
                                <td>{{ record.cost|int }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>暫無精煉記錄</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.element-item {
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.element-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.element-symbol {
    font-family: 'Courier New', monospace;
    margin-bottom: 5px;
}

.element-name {
    margin-bottom: 8px;
}

.refinery-info {
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}

.progress {
    height: 20px;
}

.progress-bar {
    font-size: 12px;
    line-height: 20px;
}

.badge.bg-success {
    background-color: #28a745 !important;
}

.badge.bg-warning {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.badge.bg-danger {
    background-color: #dc3545 !important;
}
</style>

<script>
        // 元素週期表數據（簡化版）
        const elements = [
            // 常見元素
            {symbol: "H", name: "氫", rarity: "common", color: "#e74c3c"},
            {symbol: "He", name: "氦", rarity: "common", color: "#3498db"},
            {symbol: "Li", name: "鋰", rarity: "common", color: "#f39c12"},
            {symbol: "Be", name: "鈹", rarity: "common", color: "#2ecc71"},
            {symbol: "B", name: "硼", rarity: "common", color: "#9b59b6"},
            {symbol: "C", name: "碳", rarity: "common", color: "#34495e"},
            {symbol: "N", name: "氮", rarity: "common", color: "#1abc9c"},
            {symbol: "O", name: "氧", rarity: "common", color: "#e67e22"},
            {symbol: "F", name: "氟", rarity: "common", color: "#d35400"},
            {symbol: "Ne", name: "氖", rarity: "common", color: "#8e44ad"},
            {symbol: "Na", name: "鈉", rarity: "common", color: "#f1c40f"},
            {symbol: "Mg", name: "鎂", rarity: "common", color: "#27ae60"},
            {symbol: "Al", name: "鋁", rarity: "common", color: "#7f8c8d"},
            {symbol: "Si", name: "矽", rarity: "common", color: "#bdc3c7"},
            {symbol: "P", name: "磷", rarity: "common", color: "#c0392b"},
            {symbol: "S", name: "硫", rarity: "common", color: "#f39c12"},
            {symbol: "Cl", name: "氯", rarity: "common", color: "#16a085"},
            {symbol: "Ar", name: "氬", rarity: "common", color: "#3498db"},
            
            // 稀有元素
            {symbol: "K", name: "鉀", rarity: "rare", color: "#e67e22"},
            {symbol: "Ca", name: "鈣", rarity: "rare", color: "#9b59b6"},
            {symbol: "Sc", name: "鈧", rarity: "rare", color: "#34495e"},
            {symbol: "Ti", name: "鈦", rarity: "rare", color: "#2c3e50"},
            {symbol: "V", name: "釩", rarity: "rare", color: "#8e44ad"},
            {symbol: "Cr", name: "鉻", rarity: "rare", color: "#e74c3c"},
            {symbol: "Mn", name: "錳", rarity: "rare", color: "#f39c12"},
            {symbol: "Fe", name: "鐵", rarity: "rare", color: "#7f8c8d"},
            {symbol: "Co", name: "鈷", rarity: "rare", color: "#3498db"},
            {symbol: "Ni", name: "鎳", rarity: "rare", color: "#27ae60"},
            {symbol: "Cu", name: "銅", rarity: "rare", color: "#d35400"},
            {symbol: "Zn", name: "鋅", rarity: "rare", color: "#1abc9c"},
            {symbol: "Ga", name: "鎵", rarity: "rare", color: "#c0392b"},
            {symbol: "Ge", name: "鍺", rarity: "rare", color: "#f1c40f"},
            {symbol: "As", name: "砷", rarity: "rare", color: "#2ecc71"},
            {symbol: "Se", name: "硒", rarity: "rare", color: "#95a5a6"},
            {symbol: "Br", name: "溴", rarity: "rare", color: "#e74c3c"},
            {symbol: "Kr", name: "氪", rarity: "rare", color: "#3498db"},
            {symbol: "Ag", name: "銀", rarity: "rare", color: "#bdc3c7"},
            {symbol: "Cd", name: "鎘", rarity: "rare", color: "#8e44ad"},
            {symbol: "In", name: "銦", rarity: "rare", color: "#f39c12"},
            {symbol: "Sn", name: "錫", rarity: "rare", color: "#7f8c8d"},
            {symbol: "Sb", name: "銻", rarity: "rare", color: "#34495e"},
            {symbol: "Te", name: "碲", rarity: "rare", color: "#16a085"},
            {symbol: "I", name: "碘", rarity: "rare", color: "#c0392b"},
            {symbol: "Xe", name: "氙", rarity: "rare", color: "#3498db"},
            {symbol: "Cs", name: "銫", rarity: "rare", color: "#f1c40f"},
            {symbol: "Ba", name: "鋇", rarity: "rare", color: "#27ae60"},
            {symbol: "Au", name: "金", rarity: "rare", color: "#f1c40f"},
            {symbol: "Hg", name: "汞", rarity: "rare", color: "#bdc3c7"},
            {symbol: "Tl", name: "鉈", rarity: "rare", color: "#7f8c8d"},
            {symbol: "Pb", name: "鉛", rarity: "rare", color: "#34495e"},
            {symbol: "Bi", name: "鉍", rarity: "rare", color: "#8e44ad"},
            {symbol: "Po", name: "釙", rarity: "rare", color: "#e74c3c"},
            {symbol: "At", name: "砈", rarity: "rare", color: "#d35400"},
            {symbol: "Rn", name: "氡", rarity: "rare", color: "#3498db"},
            
            // 極稀有元素
            {symbol: "Fr", name: "鈁", rarity: "very-rare", color: "#e74c3c"},
            {symbol: "Ra", name: "鐳", rarity: "very-rare", color: "#f39c12"},
            {symbol: "Ac", name: "錒", rarity: "very-rare", color: "#8e44ad"},
            {symbol: "Th", name: "釷", rarity: "very-rare", color: "#34495e"},
            {symbol: "Pa", name: "鏷", rarity: "very-rare", color: "#2c3e50"},
            {symbol: "U", name: "鈾", rarity: "very-rare", color: "#7f8c8d"},
            {symbol: "Np", name: "錼", rarity: "very-rare", color: "#1abc9c"},
            {symbol: "Pu", name: "鈈", rarity: "very-rare", color: "#c0392b"},
            {symbol: "Am", name: "鋂", rarity: "very-rare", color: "#f39c12"},
            {symbol: "Cm", name: "鋦", rarity: "very-rare", color: "#9b59b6"}
        ];

        // 用戶元素庫存數據
        const userInventory = {{ current_user.element_inventory|tojson|safe if current_user.element_inventory else '{}' }};

        document.addEventListener('DOMContentLoaded', function() {
            const refinerySelect = document.getElementById('refinery_id');
            const oreAmountInput = document.getElementById('ore_amount');
            const previewDiv = document.getElementById('refining-preview');
            const previewText = document.getElementById('preview-text');
            const elementInventoryDiv = document.getElementById('element-inventory');
            
            // 生成元素庫存顯示
            function generateElementInventory() {
                elementInventoryDiv.innerHTML = '';
                
                // 確保userInventory是對象
                const inventory = typeof userInventory === 'object' && userInventory !== null ? userInventory : {};
                
                if (Object.keys(inventory).length === 0) {
                    elementInventoryDiv.innerHTML = '<p class="text-muted">暫無元素庫存</p>';
                    return;
                }
                
                // 獲取所有材料信息
                const materials = {{ materials|tojson|safe }};
                const materialMap = {};
                materials.forEach(material => {
                    materialMap[material.symbol] = material;
                });
                
                // 生成元素卡片
                for (const [symbol, amount] of Object.entries(inventory)) {
                    if (amount > 0) {
                        const material = materialMap[symbol];
                        if (material) {
                            const elementDiv = document.createElement('div');
                            elementDiv.className = 'element-item';
                            elementDiv.style.backgroundColor = material.color;
                            elementDiv.innerHTML = `
                                <div class="element-symbol">${symbol}</div>
                                <div class="element-name">${material.name}</div>
                                <div class="element-amount">${amount.toFixed(2)}</div>
                            `;
                            elementInventoryDiv.appendChild(elementDiv);
                        }
                    }
                }
            }
            
            function updatePreview() {
                const refinery = refinerySelect.options[refinerySelect.selectedIndex];
                const oreAmount = parseFloat(oreAmountInput.value) || 0;
                
                if (refinery.value && oreAmount > 0) {
                    const efficiency = parseFloat(refinery.dataset.efficiency);
                    const costPerOre = parseFloat(refinery.dataset.cost);
                    const refiningMultiplier = parseFloat(refinery.dataset.refiningMultiplier);
                    const environmentMultiplier = parseFloat(refinery.dataset.environmentMultiplier);
                    const correctionFactor = parseFloat(refinery.dataset.correctionFactor);
                    
                    // 計算單個原礦的材料數量（包含所有倍數）
                    const baseRatio = 0.1;
                    const efficiencyRatio = baseRatio * efficiency;
                    const refiningRatio = efficiencyRatio * refiningMultiplier;
                    const environmentRatio = refiningRatio * environmentMultiplier;
                    const finalRatio = environmentRatio * correctionFactor;
                    const singleMaterialAmount = finalRatio;
                    
                    // 計算總材料數量（每個原礦獨立計算）
                    const totalMaterialAmount = oreAmount * singleMaterialAmount;
                    
                    const totalCost = oreAmount * costPerOre;
                    
                    previewText.innerHTML = `
                        消耗: ${oreAmount} 原礦<br>
                        預估獲得: ${totalMaterialAmount.toFixed(2)} 元素<br>
                        成本: ${totalCost.toFixed(0)} 原礦<br>
                        總消耗: ${(oreAmount + totalCost).toFixed(0)} 原礦<br>
                        <small class="text-muted">
                            效率: ${efficiency}x | 精煉: ${refiningMultiplier}x | 環境: ${environmentMultiplier}x | 修正: ${correctionFactor}x<br>
                            <i class="fas fa-info-circle"></i> 每個原礦獨立計算產出（基於稀有度隨機決定）
                        </small>
                    `;
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
            }
            
            // 初始化元素庫存顯示
            generateElementInventory();
            
            refinerySelect.addEventListener('change', updatePreview);
            oreAmountInput.addEventListener('input', updatePreview);
        });
</script>
{% endblock %} 