# 精煉系統說明

## 系統概述

精煉系統已升級為基於元素週期表的系統，採用**每個原礦獨立計算**的機制，確保每個原礦都有獨立的隨機產出機會。

## 核心機制

### 1. 獨立計算機制
- **每個原礦獨立**: 每個原礦都會進行獨立的隨機計算
- **多樣化產出**: 一次精煉可能獲得多種不同的元素
- **真實隨機**: 避免了批量計算可能導致的單一產出問題

### 2. 元素週期表系統
系統包含 64 種元素，分為三個稀有度等級：

#### 常見元素 (Common) - 18種
- 獲得機率：70%
- 包括：氫、氦、鋰、鈹、硼、碳、氮、氧、氟、氖、鈉、鎂、鋁、矽、磷、硫、氯、氬

#### 稀有元素 (Rare) - 36種  
- 獲得機率：25%
- 包括：鉀、鈣、鈧、鈦、釩、鉻、錳、鐵、鈷、鎳、銅、鋅、鎵、鍺、砷、硒、溴、氪、銀、鎘、銦、錫、銻、碲、碘、氙等

#### 極稀有元素 (Very-Rare) - 10種
- 獲得機率：5%
- 包括：鈁、鐳、錒、釷、鏷、鈾、錼、鈈、鋂、鋦

### 3. 兩階段隨機選擇
1. **第一階段**: 根據稀有度權重選擇稀有度類別
2. **第二階段**: 從選中的稀有度類別中隨機選擇具體元素

### 4. 精煉計算公式
```
單個原礦材料數量 = 基礎比率 × 效率 × 精煉倍數 × 環境倍數 × 修正系數
總材料數量 = Σ(每個原礦的材料數量)
```

## 技術實現

### 後端邏輯
```python
# 對每個原礦進行獨立計算
for i in range(int(ore_amount)):
    # 根據權重選擇稀有度
    selected_rarity = random.choices(
        list(rarity_weights.keys()),
        weights=list(rarity_weights.values())
    )[0]
    
    # 從選中的稀有度中隨機選擇元素
    selected_material = random.choice(materials_by_rarity[selected_rarity])
    
    # 計算單個原礦的精煉結果
    single_material_amount = calculate_refining_result(1, refinery, selected_material)
    
    # 累計到總結果中
    material_results[selected_material.name] += single_material_amount
```

### 數據庫模型
- **User.element_inventory**: JSON字段存儲所有元素數量
- **Material**: 包含元素符號、名稱、稀有度、顏色等屬性
- **RefiningRecord**: 記錄每次精煉的詳細信息

## 測試結果

### 獨立計算驗證
測試 10 個原礦的精煉結果：
```
原礦 1: 獲得 0.21 氬 (common)
原礦 2: 獲得 0.21 鈹 (common)  
原礦 3: 獲得 0.21 氮 (common)
原礦 4: 獲得 0.21 鈦 (rare)
原礦 5: 獲得 0.21 鈉 (common)
原礦 6: 獲得 0.21 氫 (common)
原礦 7: 獲得 0.21 氬 (common)
原礦 8: 獲得 0.21 氯 (common)
原礦 9: 獲得 0.21 銅 (rare)
原礦 10: 獲得 0.21 銻 (rare)
```

### 稀有度分布
- 常見元素：7次 (70.0%)
- 稀有元素：3次 (30.0%)  
- 極稀有元素：0次 (0.0%)

## 前端顯示

### 元素庫存顯示
- 動態生成元素庫存卡片
- 根據稀有度顯示不同顏色徽章
- 只顯示數量 > 0 的元素
- 使用元素專屬顏色作為邊框

### 精煉預覽
- 顯示預估獲得的總元素數量
- 說明每個原礦獨立計算的機制
- 實時更新預覽結果

## 優勢特點

1. **真實隨機性**: 每個原礦獨立計算，確保真正的隨機性
2. **多樣化產出**: 一次精煉可能獲得多種不同元素
3. **視覺化展示**: 元素庫存以卡片形式展示，直觀易懂
4. **稀有度系統**: 不同稀有度元素有不同的獲得機率
5. **可擴展性**: 可以輕鬆添加新的元素和稀有度等級

## 用戶體驗

- **直觀的界面**: 元素庫存以化學元素卡片形式展示
- **即時反饋**: 精煉後立即更新庫存顯示
- **詳細記錄**: 每次精煉都有完整的記錄保存
- **預覽功能**: 精煉前可以預覽預估結果 